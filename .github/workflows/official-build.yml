name: Build TalkBack via Official Partner Script

on:
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build-talkback:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. å‡†å¤‡ Java 17 ç¯å¢ƒ (è„šæœ¬å®˜æ–¹æ¨èç‰ˆæœ¬)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 2. æ·±åº¦æ¸…ç†ï¼šåŒæ—¶æ›¿æ¢ä¸¤æ¡åŒ…åè·¯å¾„
      - name: Dual-Path Package Rename
        run: |
          echo "å¼€å§‹æ‰§è¡ŒåŒé‡è·¯å¾„å…¨é‡æ›¿æ¢..."

          # å®šä¹‰ä¸¤ä¸ªå·²çŸ¥çš„ Google TalkBack åŒ…åå‰ç¼€
          PKG1="com.google.android.marvin.talkback"
          PKG2="com.google.android.accessibility.talkback"
          
          # å®šä¹‰ä½ çš„æ–°åŒ…åï¼ˆå»ºè®®ç®€çŸ­ä¸€ç‚¹ï¼Œé˜²æ­¢æŸäº›åœ°æ–¹é•¿åº¦å—é™ï¼‰
          MY_PKG="com.mycustom.tb"

          # --- ç¬¬ä¸€æ­¥ï¼šåœ°æ¯¯å¼æœç´¢æ›¿æ¢æ‰€æœ‰æ–‡æœ¬å†…å®¹ ---
          # è¿™æ ·èƒ½è¦†ç›–åˆ° Java, XML, Gradle, Proguard ç­‰æ‰€æœ‰æ–‡ä»¶
          echo "æ­£åœ¨å¤„ç†å†…å®¹æ›¿æ¢..."
          find . -type f -is_regular -exec sed -i "s/$PKG1/$MY_PKG/g" {} +
          find . -type f -is_regular -exec sed -i "s/$PKG2/$MY_PKG/g" {} +

          # --- ç¬¬äºŒæ­¥ï¼šé’ˆå¯¹æƒé™å£°æ˜çš„é¢å¤–å¤„ç† ---
          # å¾ˆå¤šæƒé™ä»¥ com.google.android.accessibility å¼€å¤´ï¼ˆä¸å¸¦ talkbackï¼‰
          # æˆ‘ä»¬ä¹Ÿéœ€è¦æŠŠè¿™äº›æƒé™çš„å‰ç¼€æ”¹æ‰ï¼Œå¦åˆ™ä¼šæœ‰ç­¾åå†²çª
          find . -type f -name "AndroidManifest.xml" -exec sed -i 's/com.google.android.accessibility/com.mycustom.accessibility/g' {} +

          # --- ç¬¬ä¸‰æ­¥ï¼šä¿®æ­£ Application ç±»è·¯å¾„ ---
          # è¿™ä¸€æ­¥è§£å†³ä½ çœ‹åˆ°çš„ TalkBackApplication å´©æºƒé—®é¢˜
          # ç¡®ä¿ Manifest é‡Œçš„ android:name æŒ‡å‘äº†ä½ ä¿®æ”¹åçš„è·¯å¾„
          find . -type f -name "AndroidManifest.xml" -exec sed -i "s/android:name=\".TalkBackApplication\"/android:name=\"$MY_PKG.TalkBackApplication\"/g" {} +

          echo "âœ… åŒé‡è·¯å¾„æ¸…ç†å®Œæ¯•"

      # 3. è¿è¡Œå®˜æ–¹ build.sh è„šæœ¬
      - name: Execute build.sh
        run: |
          # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
          chmod +x ./build.sh
          
          # æ³¨å…¥è„šæœ¬è¦æ±‚çš„ç¯å¢ƒå˜é‡
          # $ANDROID_HOME æ˜¯ GitHub Runner é¢„è£… SDK çš„æ ‡å‡†è·¯å¾„
          export ANDROID_SDK=$ANDROID_HOME
          
          # æ‰“å°è°ƒè¯•ä¿¡æ¯
          echo "ğŸš€ å¼€å§‹æ„å»º..."
          echo "Using Android SDK at: $ANDROID_SDK"
          echo "Using Java Home at: $JAVA_HOME"
          
          # æ‰§è¡Œå®˜æ–¹è„šæœ¬
          ./build.sh

      # 4. æ”¶é›†å¹¶ä¸Šä¼ ç”Ÿæˆçš„ APK
      - name: Upload TalkBack APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: TalkBack-Official-APK
          # æ ¹æ®ä½ ä¸Šæ¬¡è¿è¡Œç”Ÿæˆçš„è·¯å¾„è¿›è¡Œç²¾å‡†æŠ“å–
          path: |
            build/outputs/apk/phone/debug/talkback-phone-debug.apk
            build/outputs/apk/wear/debug/talkback-wear-debug.apk
          if-no-files-found: error
